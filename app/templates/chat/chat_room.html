{% extends "base.html" %}
{% block title %}Chat Room{% endblock %}
{% block content %}
<style>
<style>
/* PBORA (Public Benefit Organizations Regulatory Authority) Kenya Color Scheme - 2026 Modern Edition */
/* Updated to use beige, grey, and cool colors for easy-on-the-eyes design */
:root {
    --pbora-primary: #6B7280;        /* Cool grey - professional and calm */
    --pbora-secondary: #9CA3AF;      /* Light grey - subtle accent */
    --pbora-accent: #D1D5DB;         /* Beige grey - warm neutral */
    --pbora-dark: #374151;           /* Dark grey - text and depth */
    --pbora-light: #F9FAFB;          /* Off-white - clean background */
    --pbora-white: #FFFFFF;          /* Pure white */
    --pbora-gray: #6B7280;           /* Medium grey */
    --pbora-success: #10B981;        /* Muted green - success */
    --pbora-info: #6B7280;           /* Cool grey - info */
    --pbora-muted: #F3F4F6;          /* Light beige grey */

    /* 2026 Modern Additions - Muted and Subdued */
    --glass-bg: rgba(255, 255, 255, 0.95);
    --glass-border: rgba(209, 213, 219, 0.3);
    --shadow-soft: 0 4px 20px rgba(107, 114, 128, 0.08);
    --shadow-strong: 0 8px 32px rgba(107, 114, 128, 0.12);
    --gradient-primary: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
    --gradient-secondary: linear-gradient(135deg, #D1D5DB 0%, #9CA3AF 100%);
    --animation-speed: 0.3s;
    --border-radius: 12px;
    --border-radius-large: 16px;
}

/* Modern Body Styling - Matching Dashboard Background */
body {
    background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #fef3c7 100%);
    min-height: 100vh;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    overflow-x: hidden;
    color: var(--pbora-dark);
}

/* Glassmorphism Container */
.glass-container {
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-soft);
    transition: all var(--animation-speed) ease;
}

.glass-container:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-strong);
}

/* Enhanced Chat Messages - Soft and Muted */
.chat-messages {
    background: transparent;
    border-radius: var(--border-radius);
    position: relative;
    overflow: hidden;
}

.chat-messages::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(249, 250, 251, 0.9) 0%, rgba(243, 244, 246, 0.9) 100%);
    backdrop-filter: blur(8px);
    z-index: -1;
}

/* Modern Message Bubbles */
.message-wrapper {
    display: flex;
    margin-bottom: 16px;
    animation: slideIn 0.4s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-wrapper.sent {
    justify-content: flex-end;
}

.message-wrapper.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 16px 20px;
    border-radius: var(--border-radius);
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 2px 12px rgba(107, 114, 128, 0.08);
    backdrop-filter: blur(8px);
    transition: all var(--animation-speed) ease;
}

.message-bubble:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 16px rgba(107, 114, 128, 0.12);
}

.message-wrapper.sent .message-bubble {
    background: var(--glass-bg);
    color: var(--pbora-dark);
    border-bottom-right-radius: 4px;
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(12px);
}

.message-wrapper.received .message-bubble {
    background: var(--pbora-muted);
    color: var(--pbora-dark);
    border-bottom-left-radius: 4px;
    border: 1px solid rgba(209, 213, 219, 0.4);
    backdrop-filter: blur(12px);
}

/* Enhanced Sender Name - Muted */
.sender-name {
    font-size: 0.85em;
    font-weight: 600;
    color: var(--pbora-gray);
    margin-bottom: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Modern Message Text */
.message-text {
    margin-bottom: 6px;
    line-height: 1.5;
    font-size: 0.95em;
}

/* Sleek Message Time - Muted */
.message-time {
    font-size: 0.75em;
    opacity: 0.8;
    text-align: right;
    margin-top: 6px;
    font-weight: 500;
}

.message-wrapper.sent .message-time {
    color: var(--pbora-gray);
}

.message-wrapper.received .message-time {
    color: var(--pbora-gray);
}

/* Modern Media Content */
.media-content {
    margin-bottom: 10px;
}

.chat-image {
    max-width: 280px;
    max-height: 220px;
    border-radius: var(--border-radius);
    cursor: pointer;
    transition: all var(--animation-speed) ease;
    border: 2px solid transparent;
    box-shadow: 0 4px 16px rgba(0, 109, 119, 0.1);
}

.chat-image:hover {
    transform: scale(1.03);
    border-color: var(--pbora-primary);
    box-shadow: 0 8px 24px rgba(0, 109, 119, 0.2);
}

.chat-video {
    max-width: 280px;
    max-height: 220px;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 16px rgba(0, 109, 119, 0.1);
}

/* Futuristic Media Player - Muted */
.media-player {
    display: flex;
    align-items: center;
    background: var(--pbora-muted);
    backdrop-filter: blur(12px);
    border-radius: var(--border-radius-large);
    padding: 12px 16px;
    margin: 6px 0;
    gap: 12px;
    border: 1px solid rgba(209, 213, 219, 0.4);
    box-shadow: var(--shadow-soft);
    transition: all var(--animation-speed) ease;
}

.media-player:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow-strong);
}

.media-player.audio-player {
    background: rgba(107, 114, 128, 0.05);
    border: 1px solid rgba(107, 114, 128, 0.15);
}

.media-player.video-player {
    flex-direction: column;
    background: var(--pbora-muted);
    padding: 8px;
    border: 1px solid rgba(209, 213, 219, 0.4);
    box-shadow: var(--shadow-soft);
}

/* Modern Play Button - Muted */
.play-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background: var(--pbora-gray);
    color: var(--pbora-white);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--animation-speed) ease;
    box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
}

.play-button:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
    background: var(--pbora-dark);
}

.play-button:active {
    transform: scale(0.95);
}

/* Enhanced Progress Bar - Muted */
.progress-bar {
    flex: 1;
    height: 6px;
    background: rgba(209, 213, 219, 0.4);
    border-radius: 3px;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: var(--pbora-gray);
    border-radius: 3px;
    width: 0%;
    transition: width 0.1s ease;
}

/* Modern Download Button - Muted */
.download-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--pbora-accent);
    color: var(--pbora-dark);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--animation-speed) ease;
}

.download-button:hover {
    transform: scale(1.1);
    background: var(--pbora-gray);
    color: var(--pbora-white);
}

/* Loading Animation */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}

.loading-pulse {
    animation: pulse 1.5s ease-in-out infinite;
}

/* Modern Card Styling - Muted */
.card {
    border: none;
    border-radius: var(--border-radius-large);
    box-shadow: var(--shadow-soft);
    backdrop-filter: blur(8px);
    background: var(--glass-bg);
    transition: all var(--animation-speed) ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-strong);
}

.card-header {
    background: var(--pbora-muted);
    border: none;
    border-radius: var(--border-radius-large) var(--border-radius-large) 0 0 !important;
    backdrop-filter: blur(8px);
}

.card-footer {
    background: var(--glass-bg);
    border: none;
    border-radius: 0 0 var(--border-radius-large) var(--border-radius-large);
    backdrop-filter: blur(8px);
}

/* Modern Button Styling - Muted */
.btn {
    border-radius: var(--border-radius);
    font-weight: 600;
    transition: all var(--animation-speed) ease;
    border: none;
    box-shadow: 0 2px 8px rgba(107, 114, 128, 0.1);
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(107, 114, 128, 0.15);
}

.btn-primary {
    background: var(--pbora-gray);
    color: var(--pbora-white);
}

.btn-primary:hover {
    background: var(--pbora-dark);
}

.btn-success {
    background: var(--pbora-success);
}

.btn-success:hover {
    background: #047857;
}

/* Modern Form Styling - Muted */
.form-control {
    border-radius: var(--border-radius);
    border: 1px solid rgba(209, 213, 219, 0.4);
    background: var(--glass-bg);
    backdrop-filter: blur(8px);
    transition: all var(--animation-speed) ease;
}

.form-control:focus {
    border-color: var(--pbora-gray);
    box-shadow: 0 0 0 0.2rem rgba(107, 114, 128, 0.25);
    background: rgba(255, 255, 255, 0.95);
}

/* Modern Media Container - Muted */
.modern-media-container {
    background: linear-gradient(135deg, rgba(249, 250, 251, 0.9) 0%, rgba(243, 244, 246, 0.9) 100%);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(209, 213, 219, 0.4);
    border-radius: var(--border-radius);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow-soft);
}

.modern-media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 16px;
}

.modern-media-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.modern-media-btn {
    width: 100%;
    padding: 16px;
    border: none;
    border-radius: var(--border-radius);
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--animation-speed) ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.modern-media-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
}

.modern-media-btn-primary {
    background: var(--gradient-primary);
}

.modern-media-btn-success {
    background: var(--gradient-secondary);
}

.modern-media-btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.media-icon {
    font-size: 1.5em;
}

.media-text {
    font-size: 0.9em;
    text-align: center;
}

.modern-upload-btn {
    padding: 6px 12px;
    background: var(--pbora-gray);
    color: white;
    border-radius: 20px;
    font-size: 0.8em;
    cursor: pointer;
    transition: all var(--animation-speed) ease;
}

.modern-upload-btn:hover {
    background: var(--pbora-dark);
    transform: scale(1.05);
}

/* Modern Loading State */
#loading-messages {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    animation: fadeIn 0.5s ease-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.spinner-border {
    width: 3rem;
    height: 3rem;
    border: 0.25em solid var(--pbora-primary);
    border-right-color: transparent;
    animation: spinner-border 0.75s linear infinite;
}

/* Modern Breadcrumb */
.breadcrumb {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius);
    padding: 12px 16px;
    border: 1px solid var(--glass-border);
}

.breadcrumb-item a {
    color: var(--pbora-primary);
    text-decoration: none;
    transition: color var(--animation-speed) ease;
}

.breadcrumb-item a:hover {
    color: var(--pbora-dark);
}

/* Responsive Design */
@media (max-width: 768px) {
    .chat-messages {
        height: 500px;
    }

    .message-bubble {
        max-width: 85%;
    }

    .modern-media-grid {
        grid-template-columns: 1fr;
    }

    .glass-container {
        margin: 10px;
        border-radius: var(--border-radius);
    }
}

/* Fullscreen Mode */
.fullscreen-chat {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    z-index: 9999 !important;
    background: var(--glass-bg) !important;
    backdrop-filter: blur(20px) !important;
}

.fullscreen-chat .chat-messages {
    height: calc(100vh - 200px) !important;
}

/* Dark Mode Support (Future Enhancement) */
@media (prefers-color-scheme: dark) {
    :root {
        --pbora-light: #1a202c;
        --pbora-white: #2d3748;
        --glass-bg: rgba(45, 55, 72, 0.8);
        --glass-border: rgba(255, 255, 255, 0.1);
    }
}

.chat-messages {
    background: linear-gradient(135deg, var(--pbora-light) 0%, #E5E7EB 100%);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(107, 114, 128, 0.08);
    border: 1px solid rgba(209, 213, 219, 0.3);
}

.message-wrapper {
    display: flex;
    margin-bottom: 10px;
}

.message-wrapper.sent {
    justify-content: flex-end;
}

.message-wrapper.received {
    justify-content: flex-start;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(107, 114, 128, 0.08);
}

.message-wrapper.sent .message-bubble {
    background: var(--glass-bg);
    color: var(--pbora-dark);
    border-bottom-right-radius: 4px;
    border: 1px solid var(--glass-border);
}

.message-wrapper.received .message-bubble {
    background: var(--pbora-muted);
    color: var(--pbora-dark);
    border-bottom-left-radius: 4px;
    border: 1px solid rgba(209, 213, 219, 0.4);
    box-shadow: 0 2px 12px rgba(107, 114, 128, 0.06);
}

.sender-name {
    font-size: 0.8em;
    font-weight: bold;
    color: var(--pbora-gray);
    margin-bottom: 4px;
}

.message-text {
    margin-bottom: 4px;
    line-height: 1.4;
}

.message-time {
    font-size: 0.7em;
    opacity: 0.7;
    text-align: right;
    margin-top: 4px;
    color: rgba(255, 255, 255, 0.8);
}

.message-wrapper.sent .message-time {
    color: rgba(255, 255, 255, 0.8);
}

.message-wrapper.received .message-time {
    color: var(--pbora-gray);
}

.media-content {
    margin-bottom: 8px;
}

.chat-image {
    max-width: 250px;
    max-height: 200px;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.2s;
    border: 2px solid rgba(0, 109, 119, 0.1);
}

.chat-image:hover {
    transform: scale(1.05);
    border-color: var(--pbora-primary);
}

.chat-video {
    max-width: 250px;
    max-height: 200px;
    border-radius: 12px;
}

.voice-player {
    width: 100%;
    max-width: 200px;
}

/* Enhanced media player styling */
.media-player {
    display: flex;
    align-items: center;
    background: rgba(0, 109, 119, 0.05);
    border-radius: 20px;
    padding: 8px 12px;
    margin: 4px 0;
    gap: 8px;
    border: 1px solid rgba(0, 109, 119, 0.1);
}

.media-player.audio-player {
    background: rgba(0, 109, 119, 0.08);
    border: 1px solid rgba(0, 109, 119, 0.15);
}

.media-player.video-player {
    flex-direction: column;
    background: var(--pbora-white);
    padding: 4px;
    border: 1px solid rgba(0, 109, 119, 0.1);
    box-shadow: 0 2px 8px rgba(0, 109, 119, 0.08);
}

.play-button {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    border: none;
    background: var(--pbora-primary);
    color: var(--pbora-white);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0, 109, 119, 0.3);
}

.play-button:hover {
    background: var(--pbora-dark);
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 109, 119, 0.4);
}

.play-button.playing {
    background: var(--pbora-success);
}

.play-button.playing:hover {
    background: #047857;
}

.media-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.media-type {
    font-size: 12px;
    font-weight: 500;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.media-duration {
    font-size: 11px;
    color: #888;
}

.media-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.progress-bar {
    flex: 1;
    height: 4px;
    background: rgba(0, 109, 119, 0.2);
    border-radius: 2px;
    cursor: pointer;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: var(--pbora-primary);
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s;
}

.download-button {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: none;
    background: rgba(0, 109, 119, 0.1);
    color: var(--pbora-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 12px;
}

.download-button:hover {
    background: var(--pbora-primary);
    color: var(--pbora-white);
}

.hidden-audio {
    display: none;
}

/* Video player improvements */
.chat-video {
    max-width: 250px;
    max-height: 200px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Custom audio player styling */
.voice-player::-webkit-media-controls-panel {
    background: rgba(255,255,255,0.9);
    border-radius: 10px;
}

.voice-player::-webkit-media-controls-current-time-display,
.voice-player::-webkit-media-controls-time-remaining-display {
    color: #333;
}

/* Image modal */
.image-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
    align-items: center;
    justify-content: center;
}

.image-modal img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 10px;
}

.image-modal .close {
    position: absolute;
    top: 20px;
    right: 30px;
    color: white;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
}

/* Message form styling */
.message-form .btn-primary {
    background: var(--pbora-primary);
    border-color: var(--pbora-primary);
    color: var(--pbora-white);
    font-weight: 500;
    padding: 8px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 109, 119, 0.3);
    transition: all 0.2s;
}

.message-form .btn-primary:hover {
    background: var(--pbora-dark);
    border-color: var(--pbora-dark);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 109, 119, 0.4);
}

.message-form .form-control {
    border: 2px solid var(--pbora-light);
    border-radius: 8px;
    padding: 12px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.message-form .btn-outline-primary {
    border-color: var(--pbora-primary);
    color: var(--pbora-primary);
    background: transparent;
    transition: all 0.2s;
}

.message-form .btn-outline-primary:hover {
    background: var(--pbora-primary);
    border-color: var(--pbora-primary);
    color: var(--pbora-white);
}

.message-form .btn-outline-success {
    border-color: var(--pbora-secondary);
    color: var(--pbora-secondary);
    background: transparent;
    transition: all 0.2s;
}

.message-form .btn-outline-success:hover {
    background: var(--pbora-secondary);
    border-color: var(--pbora-secondary);
    color: var(--pbora-white);
}

.message-form .btn-outline-warning {
    border-color: #f59e0b;
    color: #f59e0b;
    background: transparent;
    transition: all 0.2s;
}

.message-form .btn-outline-warning:hover {
    background: #f59e0b;
    border-color: #f59e0b;
    color: white;
}

/* Modal button styling */
.modal .btn-primary {
    background: var(--pbora-primary);
    border-color: var(--pbora-primary);
}

.modal .btn-primary:hover {
    background: var(--pbora-dark);
    border-color: var(--pbora-dark);
}

.modal .btn-success {
    background: var(--pbora-secondary);
    border-color: var(--pbora-secondary);
}

.modal .btn-success:hover {
    background: #047857;
    border-color: #047857;
}

.modal .btn-warning {
    background: #f59e0b;
    border-color: #f59e0b;
}

.modal .btn-warning:hover {
    background: #d97706;
    border-color: #d97706;
}

/* Room members styling */
.btn-outline-danger {
    border-color: #dc3545;
    color: #dc3545;
    background: transparent;
    transition: all 0.2s;
}

.btn-outline-danger:hover {
    background: #dc3545;
    border-color: #dc3545;
    color: white;
}

/* Avatar circles */
.avatar-circle {
    font-size: 16px;
    font-weight: 600;
}

/* PBORA gradient backgrounds - Muted */
.pbora-gradient {
    background: linear-gradient(135deg, var(--pbora-muted) 0%, var(--pbora-light) 100%);
}

/* Enhanced message bubbles */
.message-bubble {
    transition: all 0.2s ease;
}

.message-bubble:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

/* Loading spinner */
.spinner-border-sm {
    width: 1rem;
    height: 1rem;
}

/* Enhanced form styling */
.form-floating > .form-control {
    border-radius: 0.375rem 0 0 0.375rem;
}

.input-group .btn {
    border-radius: 0 0.375rem 0.375rem 0;
}

/* Media upload buttons */
.btn-outline-primary:hover, .btn-outline-success:hover, .btn-outline-warning:hover, .btn-outline-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* Modal enhancements */
.modal-content {
    border-radius: 1rem;
    overflow: hidden;
}

.modal-header {
    border-bottom: none;
}

.modal-footer {
    border-top: 1px solid rgba(0,0,0,0.1);
}

/* Card enhancements */
.card {
    transition: all 0.2s ease;
}

.card:hover {
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.card-header {
    font-weight: 600;
}

/* Badge enhancements */
.badge {
    font-size: 0.75em;
}

/* Responsive improvements */
@media (max-width: 768px) {
    .container-fluid {
        padding-left: 15px;
        padding-right: 15px;
    }

    .chat-messages {
        height: 400px !important;
    }

    .modal-dialog {
        margin: 0.5rem;
    }

    .btn-group-vertical .btn {
        border-radius: 0.375rem !important;
    }
}

/* Scroll to bottom button */
.scroll-to-bottom {
    position: fixed;
    bottom: 100px;
    right: 20px;
    z-index: 1000;
    display: none;
}

/* Typing indicator */
.typing-indicator {
    font-style: italic;
    color: var(--pbora-gray);
    padding: 8px 16px;
    margin-bottom: 10px;
}

/* Message status indicators - Muted */
.message-status {
    font-size: 0.7em;
    margin-left: 8px;
    opacity: 0.7;
}

.message-status.sent {
    color: var(--pbora-success);
}

.message-status.delivered {
    color: var(--pbora-gray);
}

.message-status.read {
    color: var(--pbora-dark);
}

/* Mobile responsiveness improvements */
@media (max-width: 768px) {
    .message-bubble {
        max-width: 85%;
    }
    .chat-image, .chat-video {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }
    .media-player.video-player {
        max-width: 100%;
    }
}

/* Scale down media capture icons by 70% (to 30% of original size) */
.btn i.fas.fa-camera,
.btn i.fas.fa-microphone,
.btn i.fas.fa-video {
    transform: scale(0.3);
}

/* Modern Media Section Styles */
.modern-media-container {
    background: linear-gradient(135deg, rgba(249, 250, 251, 0.9) 0%, rgba(243, 244, 246, 0.9) 100%);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(209, 213, 219, 0.4);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(107, 114, 128, 0.08);
    position: relative;
    overflow: hidden;
}

.modern-media-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--pbora-gray), var(--pbora-accent), var(--pbora-muted));
    border-radius: 16px 16px 0 0;
}

.modern-media-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 16px;
    margin-top: 16px;
}

.modern-media-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
}

.modern-media-btn {
    width: 100%;
    height: 100px;
    border: none;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    font-weight: 500;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.modern-media-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
    opacity: 0;
    transition: opacity 0.3s;
}

.modern-media-btn:hover::before {
    opacity: 1;
}

.modern-media-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

.modern-media-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.modern-media-btn-primary {
    background: linear-gradient(135deg, var(--pbora-gray) 0%, var(--pbora-dark) 100%);
    color: white;
}

.modern-media-btn-success {
    background: linear-gradient(135deg, var(--pbora-success) 0%, #10b981 100%);
    color: white;
}

.modern-media-btn-warning {
    background: linear-gradient(135deg, var(--pbora-accent) 0%, var(--pbora-gray) 100%);
    color: var(--pbora-dark);
}

.media-icon {
    font-size: 24px;
    margin-bottom: 8px;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
}

.media-text {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.modern-upload-btn {
    width: 100%;
    padding: 6px 12px;
    border: 1px solid rgba(0, 109, 119, 0.3);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.8);
    color: var(--pbora-primary);
    font-size: 11px;
    font-weight: 500;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    backdrop-filter: blur(5px);
}

.modern-upload-btn:hover {
    background: rgba(255, 255, 255, 0.9);
    border-color: var(--pbora-primary);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 109, 119, 0.2);
}
</style>

<div class="container-fluid mt-4">
    <!-- Modern Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('chat.rooms') }}" class="text-decoration-none">
                            <i class="fas fa-arrow-left me-1"></i>Chat Rooms
                        </a>
                    </li>
                    <li class="breadcrumb-item active">{{ room.name }}</li>
                </ol>
            </nav>

            <div class="glass-container p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="mb-1 text-dark">
                            <i class="fas fa-comments me-2"></i>{{ room.name }}
                        </h2>
                        {% if room.file %}
                        <small class="text-muted">
                            <i class="fas fa-file me-1"></i>{{ room.file.file_number }}
                        </small>
                        {% endif %}
                        <div class="mt-2">
                            <span class="badge bg-light text-dark me-2">
                                <i class="fas fa-users me-1"></i><span id="online-count">0</span> Online
                            </span>
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-clock me-1"></i>Last active: <span id="last-activity">Now</span>
                            </span>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-light btn-sm" onclick="scrollToBottom()" title="Scroll to bottom">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button class="btn btn-light btn-sm" onclick="toggleFullscreen()" title="Toggle fullscreen">
                            <i class="fas fa-expand"></i>
                        </button>
                        {% if current_user.is_admin %}
                        <div class="dropdown">
                            <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="showRoomSettings()">
                                    <i class="fas fa-edit me-2"></i>Room Settings
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="confirmDeleteRoom()">
                                    <i class="fas fa-trash me-2"></i>Delete Room
                                </a></li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Chat Area -->
        <div class="col-lg-8">
            <!-- Messages Container -->
            <div class="card h-100">
                <div class="card-body p-0">
                    <div id="messages" class="chat-messages p-4" style="height: 600px; overflow-y: auto;">
                        <!-- Messages will be loaded here -->
                        <div class="text-center text-muted py-5 loading-pulse" id="loading-messages">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="h5 mb-2">Loading messages...</div>
                            <div class="text-muted">Please wait while we fetch the latest conversations</div>
                        </div>
                    </div>
                </div>

                <!-- Modern Message Input Form -->
                <div class="card-footer">
                    <form method="POST" enctype="multipart/form-data" class="message-form">
                        {{ form.hidden_tag() }}

                        <!-- Media Upload Section -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="toggleMediaSection()">
                                <i class="fas fa-paperclip me-1"></i>Share Media
                            </button>
                            <div id="media-section" class="collapse">
                                <div class="modern-media-container">
                                    <div class="modern-media-grid">
                                        <div class="modern-media-item">
                                            <button type="button" class="modern-media-btn modern-media-btn-primary" onclick="openMediaCapture('image')" title="Take Photo">
                                                <div class="media-icon">
                                                    <i class="fas fa-camera"></i>
                                                </div>
                                                <div class="media-text">Take Photo</div>
                                            </button>
                                            <label for="image" class="modern-upload-btn" title="Upload Image">
                                                <i class="fas fa-upload me-1"></i>Upload
                                            </label>
                                            {{ form.image(class="d-none", id="image", accept="image/*") }}
                                        </div>
                                        <div class="modern-media-item">
                                            <button type="button" class="modern-media-btn modern-media-btn-success" onclick="openMediaCapture('audio')" title="Record Audio">
                                                <div class="media-icon">
                                                    <i class="fas fa-microphone"></i>
                                                </div>
                                                <div class="media-text">Record Audio</div>
                                            </button>
                                            <label for="voice_note" class="modern-upload-btn" title="Upload Audio">
                                                <i class="fas fa-upload me-1"></i>Upload
                                            </label>
                                            {{ form.voice_note(class="d-none", id="voice_note", accept="audio/*") }}
                                        </div>
                                        <div class="modern-media-item">
                                            <button type="button" class="modern-media-btn modern-media-btn-warning" onclick="openMediaCapture('video')" title="Record Video">
                                                <div class="media-icon">
                                                    <i class="fas fa-video"></i>
                                                </div>
                                                <div class="media-text">Record Video</div>
                                            </button>
                                            <label for="video_note" class="modern-upload-btn" title="Upload Video">
                                                <i class="fas fa-upload me-1"></i>Upload
                                            </label>
                                            {{ form.video_note(class="d-none", id="video_note", accept="video/*") }}
                                        </div>
                                    </div>

                                    <!-- File name display -->
                                    <div class="mt-3">
                                        <small id="file-info" class="text-muted"></small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modern Message Input -->
                        <div class="d-flex gap-2 align-items-end">
                            <div class="flex-grow-1">
                                <div class="form-floating">
                                    {{ form.message(class="form-control", placeholder="Type your message... (optional with media)", rows=1, style="min-height: 50px; resize: none; border-radius: 25px;") }}
                                    <label for="message" class="text-muted">
                                        <i class="fas fa-comment-dots me-1"></i>Type your message...
                                    </label>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary rounded-pill" onclick="toggleMediaSection()" title="Share Media">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button type="submit" class="btn btn-primary rounded-pill px-4" title="Send Message">
                                <i class="fas fa-paper-plane"></i>
                                <span class="d-none d-sm-inline ms-1">Send</span>
                            </button>
                        </div>

                        {% if form.message.errors %}
                            <div class="mt-2">
                                {% for error in form.message.errors %}
                                <div class="text-danger small">
                                    <i class="fas fa-exclamation-triangle me-1"></i>{{ error }}
                                </div>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>

        <!-- Media Capture Modal -->
        <div class="modal fade" id="mediaCaptureModal" tabindex="-1" aria-labelledby="mediaCaptureModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
                <div class="modal-content border-0 shadow-lg">
                    <div class="modal-header bg-gradient pbora-gradient text-dark">
                        <h5 class="modal-title" id="mediaCaptureModalLabel">
                            <i class="fas fa-camera me-2"></i>Capture Media
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body p-4">
                        <!-- Media Type Selection -->
                        <div id="media-type-selection" class="text-center mb-4">
                            <h6 class="text-muted mb-3">Choose Media Type</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-primary w-100 h-100 p-4" onclick="selectMediaType('image')">
                                        <i class="fas fa-camera fa-3x mb-3"></i>
                                        <div class="h5 mb-1">Photo</div>
                                        <small class="text-muted">Take or upload image</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-success w-100 h-100 p-4" onclick="selectMediaType('audio')">
                                        <i class="fas fa-microphone fa-3x mb-3"></i>
                                        <div class="h5 mb-1">Audio</div>
                                        <small class="text-muted">Record voice message</small>
                                    </button>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-outline-warning w-100 h-100 p-4" onclick="selectMediaType('video')">
                                        <i class="fas fa-video fa-3x mb-3"></i>
                                        <div class="h5 mb-1">Video</div>
                                        <small class="text-muted">Record video message</small>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Camera Preview -->
                        <div id="camera-preview" class="d-none">
                            <div class="text-center mb-3">
                                <h6 class="text-primary">
                                    <i class="fas fa-camera me-2"></i>Camera Preview
                                </h6>
                            </div>
                            <div class="ratio ratio-16x9 bg-dark rounded mb-3">
                                <video id="camera-stream" autoplay playsinline class="rounded"></video>
                            </div>
                            <canvas id="photo-canvas" class="d-none"></canvas>
                            <div class="d-flex justify-content-center gap-2">
                                <button type="button" id="capture-photo" class="btn btn-primary btn-lg">
                                    <i class="fas fa-camera me-2"></i>Take Photo
                                </button>
                                <button type="button" id="retake-photo" class="btn btn-outline-secondary d-none">
                                    <i class="fas fa-redo me-2"></i>Retake
                                </button>
                            </div>
                        </div>

                        <!-- Audio Recording -->
                        <div id="audio-recording" class="d-none">
                            <div class="text-center mb-3">
                                <h6 class="text-success">
                                    <i class="fas fa-microphone me-2"></i>Audio Recording
                                </h6>
                            </div>
                            <div class="card bg-light border-0">
                                <div class="card-body text-center py-5">
                                    <div id="audio-waveform" class="mb-4">
                                        <i class="fas fa-microphone fa-4x text-muted mb-3"></i>
                                        <div class="text-muted">Click "Start Recording" to begin</div>
                                    </div>
                                    <div class="d-flex justify-content-center gap-3 mb-3">
                                        <button type="button" id="start-audio-recording" class="btn btn-success btn-lg">
                                            <i class="fas fa-circle me-2"></i>Start Recording
                                        </button>
                                        <button type="button" id="stop-audio-recording" class="btn btn-danger btn-lg d-none">
                                            <i class="fas fa-stop me-2"></i>Stop Recording
                                        </button>
                                    </div>
                                    <div id="audio-timer" class="h4 text-primary fw-bold">00:00</div>
                                </div>
                            </div>
                        </div>

                        <!-- Video Recording -->
                        <div id="video-recording" class="d-none">
                            <div class="text-center mb-3">
                                <h6 class="text-warning">
                                    <i class="fas fa-video me-2"></i>Video Recording
                                </h6>
                            </div>
                            <div class="ratio ratio-16x9 bg-dark rounded mb-3">
                                <video id="video-stream" autoplay playsinline muted class="rounded"></video>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-3">
                                <button type="button" id="start-video-recording" class="btn btn-warning btn-lg">
                                    <i class="fas fa-circle me-2"></i>Start Recording
                                </button>
                                <button type="button" id="stop-video-recording" class="btn btn-danger btn-lg d-none">
                                    <i class="fas fa-stop me-2"></i>Stop Recording
                                </button>
                            </div>
                            <div id="video-timer" class="h4 text-warning fw-bold text-center">00:00</div>
                        </div>

                        <!-- Preview -->
                        <div id="media-preview" class="d-none">
                            <div class="text-center mb-3">
                                <h6 class="text-info">
                                    <i class="fas fa-eye me-2"></i>Preview
                                </h6>
                            </div>
                            <div class="card">
                                <div class="card-body">
                                    <div id="preview-container" class="text-center"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer bg-light">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>Cancel
                        </button>
                        <button type="button" id="use-media" class="btn btn-primary d-none">
                            <i class="fas fa-check me-2"></i>Use This Media
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modern Sidebar -->
        <div class="col-lg-4">
            <!-- Room Members -->
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-users me-2"></i>Room Members
                            <span class="badge bg-primary rounded-pill ms-2">{{ members|length }}</span>
                        </h5>
                        <small class="text-muted">{{ members|length }} member{{ 's' if members|length != 1 else '' }}</small>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="room-members" class="list-group list-group-flush">
                        {% for member in members %}
                        <div class="list-group-item px-3 py-3 border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 45px; height: 45px; font-weight: bold; font-size: 1.1em;">
                                        {{ member.user.name[0].upper() }}
                                    </div>
                                    <div>
                                        <div class="fw-bold">{{ member.user.name }}</div>
                                        {% if member.user.designation %}
                                        <small class="text-muted">{{ member.user.designation }}</small>
                                        {% endif %}
                                        {% if member.user.id == current_user.id %}
                                        <small class="badge bg-success rounded-pill px-2 py-1">You</small>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if current_user.is_admin and member.user_id != current_user.id %}
                                <button type="button" class="btn btn-sm btn-outline-danger rounded-pill" onclick="confirmRemoveUser('{{ member.user.name }}', {{ member.user_id }})" title="Remove from room">
                                    <i class="fas fa-user-minus"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Add User Section (Admin Only) -->
            {% if current_user.is_admin %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-user-plus me-2"></i>Add Member
                    </h6>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('chat.add_user_to_room', room_id=room.id) }}" id="add-user-form">
                        <div class="d-flex gap-2">
                            <select name="username" class="form-select form-select-sm" required>
                                <option value="">Select a user...</option>
                                {% for user in available_users %}
                                <option value="{{ user.name }}">{{ user.name }} ({{ user.designation }})</option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-success rounded-pill">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Modern Room Statistics -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Room Stats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <div class="glass-container p-3 text-center">
                                <div class="h4 text-primary mb-1" id="message-count">0</div>
                                <small class="text-muted fw-bold">Messages</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="glass-container p-3 text-center">
                                <div class="h4 text-success mb-1">{{ members|length }}</div>
                                <small class="text-muted fw-bold">Members</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="glass-container p-3 text-center">
                                <div class="h4 text-warning mb-1" id="media-count">0</div>
                                <small class="text-muted fw-bold">Media</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="glass-container p-3 text-center">
                                <div class="h4 text-info mb-1" id="active-users">0</div>
                                <small class="text-muted fw-bold">Active</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <span class="close" onclick="closeImageModal()">&times;</span>
    <img id="modalImage" src="" alt="Full size image">
</div>
{% endblock %}

{% block scripts %}
<script>
const socket = io();
const roomId = {{ room.id }};
const currentUser = '{{ current_user.name }}';

// Media capture variables
let currentMediaType = null;
let mediaStream = null;
let mediaRecorder = null;
let recordedChunks = [];
let capturedFile = null;
let recordingTimer = null;
let recordingStartTime = null;

// Join room
socket.emit('join', { room_id: roomId });

// Handle incoming messages
socket.on('receive_message', (data) => {
    const messagesDiv = document.getElementById('messages');
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${data.sender === currentUser ? 'sent' : 'received'} mb-3`;
    
    const messageBubble = document.createElement('div');
    messageBubble.className = 'message-bubble';
    
    let content = '';
    
    // Add sender name for received messages
    if (data.sender !== currentUser) {
        content += `<div class="sender-name">${data.sender}</div>`;
    }
    
    // Add media content
    if (data.image_filename) {
        content += `<div class="media-content">
            <img src="/static/uploads/chat/${data.image_filename}" 
                 class="chat-image" alt="Shared image" onclick="openImageModal(this.src)">
        </div>`;
    }
    
    if (data.voice_filename) {
        content += `<div class="media-content">
            <div class="media-player audio-player" data-filename="${data.voice_filename}" data-type="audio">
                <button class="play-button" onclick="togglePlayback(this)">
                    <span class="play-icon"></span>
                </button>
                <div class="media-info">
                    <div class="media-type">Voice Message</div>
                    <div class="progress-bar" onclick="seekAudio(event, this)">
                        <div class="progress-fill"></div>
                    </div>
                </div>
                <button class="download-button" onclick="downloadMedia('/static/uploads/chat/${data.voice_filename}', 'voice_message.webm')" title="Download">
                    
                </button>
                <audio class="hidden-audio">
                    <source src="/static/uploads/chat/${data.voice_filename}" type="audio/webm">
                    <source src="/static/uploads/chat/${data.voice_filename}" type="audio/mpeg">
                    <source src="/static/uploads/chat/${data.voice_filename}" type="audio/wav">
                </audio>
            </div>
        </div>`;
    }
    
    if (data.video_filename) {
        content += `<div class="media-content">
            <div class="media-player video-player">
                <video controls class="chat-video" preload="metadata">
                    <source src="/static/uploads/chat/${data.video_filename}" type="video/webm">
                    <source src="/static/uploads/chat/${data.video_filename}" type="video/mp4">
                    Your browser does not support the video element.
                </video>
                <div class="media-controls" style="margin-top: 8px;">
                    <button class="download-button" onclick="downloadMedia('/static/uploads/chat/${data.video_filename}', 'video_message.webm')" title="Download Video" style="margin-left: auto;">
                         Download
                    </button>
                </div>
            </div>
        </div>`;
    }
    
    // Add text message
    if (data.message) {
        content += `<div class="message-text">${data.message}</div>`;
    }
    
    // Add timestamp
    content += `<div class="message-time">${data.timestamp || new Date().toLocaleTimeString()}</div>`;
    
    messageBubble.innerHTML = content;
    messageWrapper.appendChild(messageBubble);
    messagesDiv.appendChild(messageWrapper);
    
    // Scroll to bottom
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

// Media capture functions
function openMediaCapture(type) {
    currentMediaType = type;
    capturedFile = null;
    
    // Reset modal
    document.getElementById('camera-preview').classList.add('d-none');
    document.getElementById('audio-recording').classList.add('d-none');
    document.getElementById('video-recording').classList.add('d-none');
    document.getElementById('media-preview').classList.add('d-none');
    document.getElementById('use-media').classList.add('d-none');
    
    // Show appropriate interface
    if (type === 'image') {
        startCamera();
    } else if (type === 'audio') {
        document.getElementById('audio-recording').classList.remove('d-none');
    } else if (type === 'video') {
        startVideoRecording();
    }
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('mediaCaptureModal'));
    modal.show();
}

async function startCamera() {
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' },
            audio: false 
        });
        
        const videoElement = document.getElementById('camera-stream');
        videoElement.srcObject = mediaStream;
        
        document.getElementById('camera-preview').classList.remove('d-none');
    } catch (error) {
        alert('Camera access denied or not available. Please check your browser permissions.');
        console.error('Camera error:', error);
    }
}

async function startVideoRecording() {
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' },
            audio: true 
        });
        
        const videoElement = document.getElementById('video-stream');
        videoElement.srcObject = mediaStream;
        
        document.getElementById('video-recording').classList.remove('d-none');
    } catch (error) {
        alert('Camera/microphone access denied or not available. Please check your browser permissions.');
        console.error('Video recording error:', error);
    }
}

// Photo capture
document.getElementById('capture-photo').addEventListener('click', () => {
    const video = document.getElementById('camera-stream');
    const canvas = document.getElementById('photo-canvas');
    const context = canvas.getContext('2d');
    
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);
    
    canvas.toBlob((blob) => {
        capturedFile = new File([blob], `photo_${Date.now()}.jpg`, { type: 'image/jpeg' });
        showPreview('image', URL.createObjectURL(blob));
        
        document.getElementById('capture-photo').classList.add('d-none');
        document.getElementById('retake-photo').classList.remove('d-none');
    }, 'image/jpeg', 0.8);
});

document.getElementById('retake-photo').addEventListener('click', () => {
    capturedFile = null;
    document.getElementById('media-preview').classList.add('d-none');
    document.getElementById('use-media').classList.add('d-none');
    document.getElementById('capture-photo').classList.remove('d-none');
    document.getElementById('retake-photo').classList.add('d-none');
});

// Audio recording
document.getElementById('start-audio-recording').addEventListener('click', async () => {
    try {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'audio/webm' });
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
                recordedChunks.push(event.data);
            }
        };
        
        mediaRecorder.onstop = () => {
            const blob = new Blob(recordedChunks, { type: 'audio/webm' });
            capturedFile = new File([blob], `audio_${Date.now()}.webm`, { type: 'audio/webm' });
            showPreview('audio', URL.createObjectURL(blob));
        };
        
        mediaRecorder.start();
        startRecordingTimer('audio');
        
        document.getElementById('start-audio-recording').classList.add('d-none');
        document.getElementById('stop-audio-recording').classList.remove('d-none');
        
        // Visual feedback
        document.getElementById('audio-waveform').innerHTML = '<div class="text-danger"> Recording...</div>';
        
    } catch (error) {
        alert('Microphone access denied or not available. Please check your browser permissions.');
        console.error('Audio recording error:', error);
    }
});

document.getElementById('stop-audio-recording').addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        mediaStream.getTracks().forEach(track => track.stop());
        stopRecordingTimer();
        
        document.getElementById('start-audio-recording').classList.remove('d-none');
        document.getElementById('stop-audio-recording').classList.add('d-none');
        document.getElementById('audio-waveform').innerHTML = '<div class="text-success"> Recording complete</div>';
    }
});

// Video recording
document.getElementById('start-video-recording').addEventListener('click', () => {
    if (!mediaStream) return;
    
    mediaRecorder = new MediaRecorder(mediaStream, { mimeType: 'video/webm' });
    recordedChunks = [];
    
    mediaRecorder.ondataavailable = (event) => {
        if (event.data.size > 0) {
            recordedChunks.push(event.data);
        }
    };
    
    mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'video/webm' });
        capturedFile = new File([blob], `video_${Date.now()}.webm`, { type: 'video/webm' });
        showPreview('video', URL.createObjectURL(blob));
    };
    
    mediaRecorder.start();
    startRecordingTimer('video');
    
    document.getElementById('start-video-recording').classList.add('d-none');
    document.getElementById('stop-video-recording').classList.remove('d-none');
});

document.getElementById('stop-video-recording').addEventListener('click', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        stopRecordingTimer();
        
        document.getElementById('start-video-recording').classList.remove('d-none');
        document.getElementById('stop-video-recording').classList.add('d-none');
    }
});

// Timer functions
function startRecordingTimer(type) {
    recordingStartTime = Date.now();
    recordingTimer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById(`${type}-timer`).textContent = `${minutes}:${seconds}`;
    }, 1000);
}

function stopRecordingTimer() {
    if (recordingTimer) {
        clearInterval(recordingTimer);
        recordingTimer = null;
    }
}

// Preview function
function showPreview(type, url) {
    const previewContainer = document.getElementById('preview-container');
    
    if (type === 'image') {
        previewContainer.innerHTML = `<img src="${url}" class="img-fluid rounded" style="max-width: 300px; max-height: 200px;">`;
    } else if (type === 'audio') {
        previewContainer.innerHTML = `
            <audio controls class="w-100">
                <source src="${url}" type="audio/webm">
                Your browser does not support the audio element.
            </audio>
        `;
    } else if (type === 'video') {
        previewContainer.innerHTML = `
            <video controls class="w-100" style="max-width: 300px;">
                <source src="${url}" type="video/webm">
                Your browser does not support the video element.
            </video>
        `;
    }
    
    document.getElementById('media-preview').classList.remove('d-none');
    document.getElementById('use-media').classList.remove('d-none');
}

// Use captured media
document.getElementById('use-media').addEventListener('click', () => {
    if (capturedFile) {
        // Create a DataTransfer to simulate file input
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(capturedFile);
        
        // Set the file to the appropriate input
        let inputId;
        if (currentMediaType === 'image') {
            inputId = 'image';
        } else if (currentMediaType === 'audio') {
            inputId = 'voice_note';
        } else if (currentMediaType === 'video') {
            inputId = 'video_note';
        }
        
        document.getElementById(inputId).files = dataTransfer.files;
        
        // Update file info display
        const sizeMB = (capturedFile.size / (1024 * 1024)).toFixed(2);
        const typeEmoji = currentMediaType === 'image' ? '' : currentMediaType === 'audio' ? '' : '';
        document.getElementById('file-info').textContent = `${typeEmoji} Captured ${currentMediaType}: ${capturedFile.name} (${sizeMB} MB)`;
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('mediaCaptureModal'));
        modal.hide();
        
        // Clean up
        cleanupMedia();
    }
});

// Modal cleanup
document.getElementById('mediaCaptureModal').addEventListener('hidden.bs.modal', () => {
    cleanupMedia();
});

function cleanupMedia() {
    if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
    }
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    stopRecordingTimer();
    capturedFile = null;
}

// Auto-scroll to bottom on load
document.addEventListener('DOMContentLoaded', function() {
    const messagesDiv = document.getElementById('messages');
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    
    // Handle file selection display for uploaded files
    const imageInput = document.getElementById('image');
    const voiceInput = document.getElementById('voice_note');
    const videoInput = document.getElementById('video_note');
    const fileInfo = document.getElementById('file-info');
    
    function updateFileInfo(input, type) {
        input.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                fileInfo.textContent = `${type}: ${file.name} (${sizeMB} MB)`;
            }
        });
    }
    
    updateFileInfo(imageInput, ' Image');
    updateFileInfo(voiceInput, ' Voice');
    updateFileInfo(videoInput, ' Video');
});

// Image modal functions
function openImageModal(src) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = 'flex';
    modalImg.src = src;
}

function closeImageModal() {
    const modal = document.getElementById('imageModal');
    modal.style.display = 'none';
}

// Close modal when clicking outside the image
document.getElementById('imageModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeImageModal();
    }
});

// Media player functions
function togglePlayback(button) {
    const player = button.closest('.media-player');
    const audio = player.querySelector('.hidden-audio');
    const playIcon = button.querySelector('.play-icon');
    const progressFill = player.querySelector('.progress-fill');
    
    if (audio.paused) {
        // Pause all other audio players
        document.querySelectorAll('.hidden-audio').forEach(otherAudio => {
            if (otherAudio !== audio && !otherAudio.paused) {
                otherAudio.pause();
                const otherPlayer = otherAudio.closest('.media-player');
                const otherButton = otherPlayer.querySelector('.play-button');
                const otherIcon = otherButton.querySelector('.play-icon');
                otherIcon.textContent = '';
                otherButton.classList.remove('playing');
            }
        });
        
        audio.play();
        playIcon.textContent = '';
        button.classList.add('playing');
        
        // Update progress bar
        audio.addEventListener('timeupdate', function() {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressFill.style.width = progress + '%';
        });
        
        // Reset when ended
        audio.addEventListener('ended', function() {
            playIcon.textContent = '';
            button.classList.remove('playing');
            progressFill.style.width = '0%';
        });
    } else {
        audio.pause();
        playIcon.textContent = '';
        button.classList.remove('playing');
    }
}

function seekAudio(event, progressBar) {
    const player = progressBar.closest('.media-player');
    const audio = player.querySelector('.hidden-audio');
    const rect = progressBar.getBoundingClientRect();
    const clickX = event.clientX - rect.left;
    const percentage = clickX / rect.width;
    const newTime = percentage * audio.duration;
    
    audio.currentTime = newTime;
}

function downloadMedia(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = filename;
    link.style.display = 'none';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Initialize UI enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Update existing media players with duration info
    document.querySelectorAll('.hidden-audio').forEach(audio => {
        audio.addEventListener('loadedmetadata', function() {
            const player = audio.closest('.media-player');
            const durationElement = player.querySelector('.media-duration');
            if (durationElement && !isNaN(audio.duration)) {
                const minutes = Math.floor(audio.duration / 60);
                const seconds = Math.floor(audio.duration % 60);
                durationElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        });
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Add scroll to bottom functionality
    const messagesContainer = document.getElementById('messages');
    const scrollButton = document.querySelector('[onclick="scrollToBottom()"]');

    messagesContainer.addEventListener('scroll', function() {
        const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
        if (scrollButton) {
            scrollButton.style.display = isNearBottom ? 'none' : 'block';
        }
    });

    // Load initial messages
    loadMessages();

    // Update room statistics
    updateRoomStats();
});

// Load messages via AJAX
function loadMessages() {
    fetch(`/api/chat/${roomId}/messages`, {
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const messagesContainer = document.getElementById('messages');
            const loadingElement = document.getElementById('loading-messages');

            if (loadingElement) {
                loadingElement.remove();
            }

            // data is already an array of messages
            data.forEach(message => {
                appendMessage(message);
            });

            scrollToBottom();
        })
        .catch(error => {
            console.error('Error loading messages:', error);
            const loadingElement = document.getElementById('loading-messages');
            if (loadingElement) {
                loadingElement.innerHTML = '<div class="text-danger">Error loading messages. Please refresh the page.</div>';
            }
        });
}

// Append a message to the chat
function appendMessage(message) {
    const messagesDiv = document.getElementById('messages');
    const messageWrapper = document.createElement('div');
    messageWrapper.className = `message-wrapper ${message.sender === currentUser ? 'sent' : 'received'} mb-3`;
    
    const messageBubble = document.createElement('div');
    messageBubble.className = 'message-bubble';
    
    let content = '';
    
    // Add sender name for received messages
    if (message.sender !== currentUser) {
        content += `<div class="sender-name">${message.sender}</div>`;
    }
    
    // Add media content
    if (message.image_filename) {
        content += `<div class="media-content">
            <img src="/static/uploads/chat/${message.image_filename}" 
                 class="chat-image" alt="Shared image" onclick="openImageModal(this.src)">
        </div>`;
    }
    
    if (message.voice_filename) {
        content += `<div class="media-content">
            <div class="media-player audio-player" data-filename="${message.voice_filename}" data-type="audio">
                <button class="play-button" onclick="togglePlayback(this)">
                    <span class="play-icon"></span>
                </button>
                <div class="media-info">
                    <div class="media-type">Voice Message</div>
                    <div class="progress-bar" onclick="seekAudio(event, this)">
                        <div class="progress-fill"></div>
                    </div>
                </div>
                <button class="download-button" onclick="downloadMedia('/static/uploads/chat/${message.voice_filename}', 'voice_message.webm')" title="Download">
                    
                </button>
                <audio class="hidden-audio">
                    <source src="/static/uploads/chat/${message.voice_filename}" type="audio/webm">
                    <source src="/static/uploads/chat/${message.voice_filename}" type="audio/mpeg">
                    <source src="/static/uploads/chat/${message.voice_filename}" type="audio/wav">
                </audio>
            </div>
        </div>`;
    }
    
    if (message.video_filename) {
        content += `<div class="media-content">
            <div class="media-player video-player">
                <video controls class="chat-video" preload="metadata">
                    <source src="/static/uploads/chat/${message.video_filename}" type="video/webm">
                    <source src="/static/uploads/chat/${message.video_filename}" type="video/mp4">
                    Your browser does not support the video element.
                </video>
                <div class="media-controls" style="margin-top: 8px;">
                    <button class="download-button" onclick="downloadMedia('/static/uploads/chat/${message.video_filename}', 'video_message.webm')" title="Download Video" style="margin-left: auto;">
                         Download
                    </button>
                </div>
            </div>
        </div>`;
    }
    
    // Add text message
    if (message.message) {
        content += `<div class="message-text">${message.message}</div>`;
    }
    
    // Add timestamp
    const timestamp = message.timestamp ? new Date(message.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
    content += `<div class="message-time">${timestamp}</div>`;
    
    messageBubble.innerHTML = content;
    messageWrapper.appendChild(messageBubble);
    messagesDiv.appendChild(messageWrapper);
}

// Update room statistics
function updateRoomStats() {
    const messageElements = document.querySelectorAll('.message-wrapper');
    const mediaElements = document.querySelectorAll('.media-content');

    document.getElementById('message-count').textContent = messageElements.length;
    document.getElementById('media-count').textContent = mediaElements.length;
    document.getElementById('active-users').textContent = Math.floor(Math.random() * 5) + 1; // Mock data
}

// Scroll to bottom function
function scrollToBottom() {
    const messagesContainer = document.getElementById('messages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Toggle media section
function toggleMediaSection() {
    const mediaSection = document.getElementById('media-section');
    const isCollapsed = mediaSection.classList.contains('collapse') || !mediaSection.classList.contains('show');
    
    if (isCollapsed) {
        mediaSection.classList.add('show');
        mediaSection.style.display = 'block';
    } else {
        mediaSection.classList.remove('show');
        mediaSection.style.display = 'none';
    }
}

// Toggle fullscreen mode
function toggleFullscreen() {
    const chatContainer = document.querySelector('.col-lg-8');
    const sidebar = document.querySelector('.col-lg-4');
    
    if (!document.fullscreenElement) {
        chatContainer.requestFullscreen().then(() => {
            if (sidebar) sidebar.style.display = 'none';
            chatContainer.classList.add('fullscreen-chat');
        }).catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen().then(() => {
            if (sidebar) sidebar.style.display = 'block';
            chatContainer.classList.remove('fullscreen-chat');
        });
    }
}

// Handle fullscreen change
document.addEventListener('fullscreenchange', function() {
    const chatContainer = document.querySelector('.col-lg-8');
    const sidebar = document.querySelector('.col-lg-4');
    
    if (!document.fullscreenElement) {
        if (sidebar) sidebar.style.display = 'block';
        chatContainer.classList.remove('fullscreen-chat');
    }
});

// Confirm user removal
function confirmRemoveUser(username, userId) {
    if (confirm(`Are you sure you want to remove ${username} from this room?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/chat/${roomId}/remove_user/${userId}`;

        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            form.appendChild(csrfToken.cloneNode());
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// Select media type in modal
function selectMediaType(type) {
    document.getElementById('media-type-selection').classList.add('d-none');

    // Hide all media sections
    ['camera-preview', 'audio-recording', 'video-recording'].forEach(id => {
        document.getElementById(id).classList.add('d-none');
    });

    // Show selected media section
    if (type === 'image') {
        document.getElementById('camera-preview').classList.remove('d-none');
        openMediaCapture('image');
    } else if (type === 'audio') {
        document.getElementById('audio-recording').classList.remove('d-none');
        openMediaCapture('audio');
    } else if (type === 'video') {
        document.getElementById('video-recording').classList.remove('d-none');
        openMediaCapture('video');
    }
}

// Open file picker
function openFilePicker() {
    document.getElementById('file_attachment').click();
}

// Show room settings (placeholder)
function showRoomSettings() {
    alert('Room settings functionality will be implemented soon.');
}

// Confirm room deletion (placeholder)
function confirmDeleteRoom() {
    if (confirm('Are you sure you want to delete this room? This action cannot be undone.')) {
        alert('Room deletion functionality will be implemented soon.');
    }
}
</script>
{% endblock %}