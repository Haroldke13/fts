{% extends "base.html" %}
{% block title %}Live Monitor{% endblock %}
{% block content %}
<style>
.collapsible-icon {
    transition: transform 0.3s ease;
}

[data-bs-toggle="collapse"].collapsed .collapsible-icon {
    transform: rotate(0deg);
}

[data-bs-toggle="collapse"]:not(.collapsed) .collapsible-icon {
    transform: rotate(180deg);
}
</style>
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1 class="mb-4">
                <i class="fas fa-tachometer-alt me-2"></i>Live System Monitor
            </h1>
            
            <!-- Real-time Activity Feed -->
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-activity me-2"></i>Real-time Activity Feed
                    </h5>
                </div>
                <div class="card-body">
                    <div id="activity-feed" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        <div class="list-group-item text-center text-muted py-4" id="no-activity">
                            <i class="fas fa-circle-notch fa-spin me-2"></i>Waiting for activity...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="card text-center shadow-sm mb-3">
                        <div class="card-body" data-bs-toggle="collapse" data-bs-target="#active-users-details" aria-expanded="false" aria-controls="active-users-details" style="cursor: pointer;">
                            <i class="fas fa-users fa-2x text-primary mb-2"></i>
                            <h4 id="active-users">{{ active_users|length }}</h4>
                            <small class="text-muted">Active Users</small>
                            <i class="fas fa-chevron-down ms-2 text-muted collapsible-icon"></i>
                        </div>
                        <div id="active-users-details" class="collapse">
                            <div class="card-body pt-0">
                                <hr>
                                <h6>Currently Active Users ({{ active_users|length }})</h6>
                                <div id="active-users-list" class="text-start small">
                                    {% for user in active_users %}
                                    <div class="d-flex justify-content-between py-1">
                                        <span>{{ user.name }}</span>
                                        <small class="text-muted">{{ user.role.title() }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm mb-3">
                        <div class="card-body" data-bs-toggle="collapse" data-bs-target="#total-files-details" aria-expanded="false" aria-controls="total-files-details" style="cursor: pointer;">
                            <i class="fas fa-folder fa-2x text-success mb-2"></i>
                            <h4 id="total-files">{{ total_files|length }}</h4>
                            <small class="text-muted">Total Files</small>
                            <i class="fas fa-chevron-down ms-2 text-muted collapsible-icon"></i>
                        </div>
                        <div id="total-files-details" class="collapse">
                            <div class="card-body pt-0">
                                <hr>
                                <h6>All Files ({{ total_files|length }})</h6>
                                <div id="total-files-list" class="text-start small" style="max-height: 200px; overflow-y: auto;">
                                    {% for file in total_files %}
                                    <div class="d-flex justify-content-between py-1">
                                        <span>{{ file.file_number }} - {{ file.title or 'Untitled' }}</span>
                                        <small class="{% if file.is_issued %}text-warning{% else %}text-success{% endif %}">
                                            {% if file.is_issued %}Issued{% else %}Available{% endif %}
                                        </small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm mb-3">
                        <div class="card-body" data-bs-toggle="collapse" data-bs-target="#total-messages-details" aria-expanded="false" aria-controls="total-messages-details" style="cursor: pointer;">
                            <i class="fas fa-comments fa-2x text-info mb-2"></i>
                            <h4 id="total-messages">{{ messages_today|length }}</h4>
                            <small class="text-muted">Messages Today</small>
                            <i class="fas fa-chevron-down ms-2 text-muted collapsible-icon"></i>
                        </div>
                        <div id="total-messages-details" class="collapse">
                            <div class="card-body pt-0">
                                <hr>
                                <h6>Today's Messages ({{ messages_today|length }})</h6>
                                <div id="total-messages-list" class="text-start small" style="max-height: 200px; overflow-y: auto;">
                                    {% for message in messages_today %}
                                    <div class="py-1">
                                        <strong>{{ message.sender.name }}:</strong> {{ message.message or '[Media message]' }}
                                        <br><small class="text-muted">{{ message.timestamp.strftime('%H:%M') }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center shadow-sm mb-3">
                        <div class="card-body" data-bs-toggle="collapse" data-bs-target="#active-transactions-details" aria-expanded="false" aria-controls="active-transactions-details" style="cursor: pointer;">
                            <i class="fas fa-exchange-alt fa-2x text-warning mb-2"></i>
                            <h4 id="active-transactions">{{ active_transactions|length }}</h4>
                            <small class="text-muted">Active Transactions</small>
                            <i class="fas fa-chevron-down ms-2 text-muted collapsible-icon"></i>
                        </div>
                        <div id="active-transactions-details" class="collapse">
                            <div class="card-body pt-0">
                                <hr>
                                <h6>Current File Transactions ({{ active_transactions|length }})</h6>
                                <div id="active-transactions-list" class="text-start small" style="max-height: 200px; overflow-y: auto;">
                                    {% for tx in active_transactions %}
                                    <div class="py-1">
                                        <strong>{{ tx.file.file_number }} - {{ tx.file.title or 'Untitled' }}</strong>
                                        <br><small>Checked out by: {{ tx.user.name }}</small>
                                        <br><small class="text-muted">Since: {{ tx.checkout_time.strftime('%H:%M') }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const socket = io();
    const activityFeed = document.getElementById('activity-feed');
    const noActivity = document.getElementById('no-activity');
    
    // Listen for admin updates
    socket.on('admin_update', function(data) {
        // Remove "no activity" message on first update
        if (noActivity) {
            noActivity.remove();
        }
        
        const activityItem = document.createElement('div');
        activityItem.className = 'list-group-item';
        
        let iconClass = 'fas fa-info-circle text-info';
        let badgeClass = 'badge bg-info';
        
        if (data.type === 'chat') {
            iconClass = 'fas fa-comments text-primary';
            badgeClass = 'badge bg-primary';
            activityItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <i class="${iconClass} me-2"></i>
                        <strong>${data.sender}</strong> sent a message in room ${data.room_id}
                        <br><small class="text-muted">${data.message}</small>
                    </div>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;
        } else if (data.type === 'file') {
            if (data.action === 'checkout') {
                iconClass = 'fas fa-arrow-up text-success';
                badgeClass = 'badge bg-success';
            } else {
                iconClass = 'fas fa-arrow-down text-warning';
                badgeClass = 'badge bg-warning';
            }
            activityItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <div>
                        <i class="${iconClass} me-2"></i>
                        File <strong>${data.file_number}</strong> ${data.action}ed by <strong>${data.user}</strong>
                    </div>
                    <small class="text-muted">${new Date().toLocaleTimeString()}</small>
                </div>
            `;
        }
        
        // Add to top of feed
        activityFeed.insertBefore(activityItem, activityFeed.firstChild);
        
        // Limit to 50 items
        while (activityFeed.children.length > 50) {
            activityFeed.removeChild(activityFeed.lastChild);
        }
        
        // Update stats (simplified - in production, fetch from server)
        updateStats();
    });
    
    function updateStats() {
        // Stats are now static from server-side data
        // In production, could add AJAX to refresh periodically
    }
    
    // Initial stats load
    updateStats();
});
</script>
{% endblock %}